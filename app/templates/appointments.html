<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindRobo ‚Äî Appointments</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    padding: 24px;
  }
  .container { max-width: 1200px; margin: 0 auto; }
  
  h1 { font-size: 2rem; color: #38bdf8; margin-bottom: 8px; }
  .subtitle { color: #94a3b8; margin-bottom: 32px; font-size: 1rem; }
  
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 2px solid #334155;
  }
  .tab {
    padding: 12px 24px;
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 1rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .tab:hover {
    color: #38bdf8;
  }
  .tab.active {
    color: #38bdf8;
    border-bottom-color: #38bdf8;
  }
  
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Appointments List */
  .appointment-card {
    background: #1e293b;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    border: 1px solid #334155;
    transition: all 0.2s;
  }
  .appointment-card:hover {
    border-color: #38bdf8;
  }
  .appointment-main {
    flex: 1;
  }
  .appointment-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #e2e8f0;
    margin-bottom: 4px;
  }
  .appointment-service {
    color: #94a3b8;
    font-size: 0.9rem;
    margin-bottom: 8px;
  }
  .appointment-datetime {
    color: #38bdf8;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .appointment-phone {
    color: #64748b;
    font-size: 0.9rem;
    margin-top: 4px;
  }
  .appointment-phone a {
    color: #38bdf8;
    text-decoration: none;
  }
  .appointment-phone a:hover {
    text-decoration: underline;
  }
  .status-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .status-confirmed {
    background: #064e3b;
    color: #10b981;
  }
  .status-pending {
    background: #7c2d12;
    color: #fb923c;
  }
  
  /* Availability Settings */
  .section {
    background: #1e293b;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }
  .section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #38bdf8;
    margin-bottom: 16px;
  }
  
  .day-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-bottom: 1px solid #334155;
  }
  .day-row:last-child {
    border-bottom: none;
  }
  .day-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
  }
  .day-checkbox input {
    width: auto;
    cursor: pointer;
  }
  .time-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }
  .time-inputs input {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 0.9rem;
  }
  
  .form-group {
    margin-bottom: 24px;
  }
  label {
    display: block;
    font-size: 0.9rem;
    color: #94a3b8;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 1rem;
    outline: none;
  }
  input:focus,
  select:focus {
    border-color: #38bdf8;
  }
  
  .btn {
    padding: 14px 24px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary {
    background: #38bdf8;
    color: #0f172a;
  }
  .btn-primary:hover {
    background: #0ea5e9;
  }
  .btn-primary:disabled {
    background: #475569;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #334155;
    border-top-color: #38bdf8;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .message {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    display: none;
  }
  .message.show {
    display: block;
  }
  .message-error {
    background: #7f1d1d;
    border: 1px solid #ef4444;
    color: #fca5a5;
  }
  .message-success {
    background: #064e3b;
    border: 1px solid #10b981;
    color: #6ee7b7;
  }
  
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #64748b;
  }
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  
  @media (max-width: 768px) {
    body {
      padding: 16px;
    }
    h1 {
      font-size: 1.5rem;
    }
    .appointment-card {
      flex-direction: column;
      align-items: start;
    }
    .day-row {
      flex-direction: column;
      align-items: start;
    }
    .time-inputs {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üìÖ Appointments</h1>
  <p class="subtitle">Manage your AI-booked appointments and availability.</p>
  
  <div class="message message-error" id="error-message"></div>
  <div class="message message-success" id="success-message"></div>
  
  <div class="tabs">
    <button class="tab active" data-tab="upcoming">Upcoming</button>
    <button class="tab" data-tab="availability">Availability Settings</button>
  </div>
  
  <!-- Upcoming Appointments -->
  <div class="tab-content active" id="upcoming-tab">
    <div id="appointments-list">
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <p>No upcoming appointments yet.</p>
      </div>
    </div>
  </div>
  
  <!-- Availability Settings -->
  <div class="tab-content" id="availability-tab">
    <div class="section">
      <div class="section-title">üïê Weekly Availability</div>
      <p style="color: #94a3b8; margin-bottom: 16px;">Set when the AI can book appointments for you.</p>
      
      <div id="days-container">
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-monday" value="monday" checked>
            <label for="day-monday" style="margin: 0; text-transform: none;">Monday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="monday-start" value="09:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="monday-end" value="17:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-tuesday" value="tuesday" checked>
            <label for="day-tuesday" style="margin: 0; text-transform: none;">Tuesday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="tuesday-start" value="09:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="tuesday-end" value="17:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-wednesday" value="wednesday" checked>
            <label for="day-wednesday" style="margin: 0; text-transform: none;">Wednesday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="wednesday-start" value="09:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="wednesday-end" value="17:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-thursday" value="thursday" checked>
            <label for="day-thursday" style="margin: 0; text-transform: none;">Thursday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="thursday-start" value="09:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="thursday-end" value="17:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-friday" value="friday" checked>
            <label for="day-friday" style="margin: 0; text-transform: none;">Friday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="friday-start" value="09:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="friday-end" value="17:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-saturday" value="saturday">
            <label for="day-saturday" style="margin: 0; text-transform: none;">Saturday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="saturday-start" value="10:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="saturday-end" value="14:00">
          </div>
        </div>
        <div class="day-row">
          <div class="day-checkbox">
            <input type="checkbox" id="day-sunday" value="sunday">
            <label for="day-sunday" style="margin: 0; text-transform: none;">Sunday</label>
          </div>
          <div class="time-inputs">
            <input type="time" id="sunday-start" value="10:00">
            <span style="color: #64748b;">to</span>
            <input type="time" id="sunday-end" value="14:00">
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">‚è±Ô∏è Appointment Settings</div>
      
      <div class="form-group">
        <label for="duration">Default Appointment Duration</label>
        <select id="duration">
          <option value="30">30 minutes</option>
          <option value="45">45 minutes</option>
          <option value="60" selected>1 hour</option>
          <option value="90">1.5 hours</option>
          <option value="120">2 hours</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="buffer">Buffer Between Appointments</label>
        <select id="buffer">
          <option value="0" selected>None</option>
          <option value="15">15 minutes</option>
          <option value="30">30 minutes</option>
          <option value="60">1 hour</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="timezone">Timezone</label>
        <select id="timezone">
          <option value="America/New_York">Eastern (ET)</option>
          <option value="America/Chicago">Central (CT)</option>
          <option value="America/Denver">Mountain (MT)</option>
          <option value="America/Los_Angeles">Pacific (PT)</option>
          <option value="America/Phoenix">Arizona (MST)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="notifications" checked style="width: auto; margin-right: 8px;">
          Send me SMS when appointments are booked
        </label>
      </div>
      
      <button class="btn btn-primary" id="save-availability-btn">
        Save Availability Settings
        <span class="spinner" style="display: none;" id="availability-spinner"></span>
      </button>
    </div>
  </div>
</div>

<script>
  const businessId = new URLSearchParams(window.location.search).get('business_id') || '00000000-0000-0000-0000-000000000001';
  
  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTab = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
  });
  
  // Load appointments
  async function loadAppointments() {
    try {
      const response = await fetch(`/api/v1/calendar/upcoming?business_id=${businessId}`);
      if (!response.ok) return;
      
      const data = await response.json();
      const appointments = data.appointments || [];
      
      if (appointments.length === 0) return;
      
      const container = document.getElementById('appointments-list');
      container.innerHTML = '';
      
      appointments.forEach(apt => {
        const card = document.createElement('div');
        card.className = 'appointment-card';
        card.innerHTML = `
          <div class="appointment-main">
            <div class="appointment-name">${escapeHtml(apt.customer_name || 'Unknown Customer')}</div>
            <div class="appointment-service">${escapeHtml(apt.service || 'Service call')}</div>
            <div class="appointment-datetime">
              üìÖ ${formatDate(apt.datetime)} at ${formatTime(apt.datetime)}
            </div>
            <div class="appointment-phone">
              üìû <a href="tel:${apt.phone}">${formatPhone(apt.phone)}</a>
            </div>
          </div>
          <div class="status-badge status-${apt.status || 'confirmed'}">
            ${apt.status || 'Confirmed'}
          </div>
        `;
        container.appendChild(card);
      });
    } catch (error) {
      console.error('Failed to load appointments:', error);
    }
  }
  
  // Load availability settings
  async function loadAvailability() {
    try {
      const response = await fetch(`/api/v1/business/${businessId}/availability`);
      if (!response.ok) return;
      
      const data = await response.json();
      
      // Set days and times
      ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
        const dayData = data.days?.[day];
        if (dayData) {
          document.getElementById(`day-${day}`).checked = dayData.enabled !== false;
          document.getElementById(`${day}-start`).value = dayData.start || '09:00';
          document.getElementById(`${day}-end`).value = dayData.end || '17:00';
        }
      });
      
      // Set other settings
      if (data.duration) document.getElementById('duration').value = data.duration;
      if (data.buffer) document.getElementById('buffer').value = data.buffer;
      if (data.timezone) document.getElementById('timezone').value = data.timezone;
      if (data.notifications !== undefined) document.getElementById('notifications').checked = data.notifications;
    } catch (error) {
      console.error('Failed to load availability:', error);
    }
  }
  
  // Save availability settings
  document.getElementById('save-availability-btn').addEventListener('click', async () => {
    hideMessages();
    const btn = document.getElementById('save-availability-btn');
    const spinner = document.getElementById('availability-spinner');
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    try {
      const days = {};
      ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
        days[day] = {
          enabled: document.getElementById(`day-${day}`).checked,
          start: document.getElementById(`${day}-start`).value,
          end: document.getElementById(`${day}-end`).value
        };
      });
      
      const response = await fetch(`/api/v1/business/${businessId}/availability`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          days,
          duration: parseInt(document.getElementById('duration').value),
          buffer: parseInt(document.getElementById('buffer').value),
          timezone: document.getElementById('timezone').value,
          notifications: document.getElementById('notifications').checked
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to save availability');
      }
      
      showSuccess('Availability settings saved successfully!');
    } catch (error) {
      showError(error.message);
    } finally {
      btn.disabled = false;
      spinner.style.display = 'none';
    }
  });
  
  // Messages
  function showError(msg) {
    document.getElementById('error-message').textContent = msg;
    document.getElementById('error-message').classList.add('show');
  }
  
  function showSuccess(msg) {
    document.getElementById('success-message').textContent = msg;
    document.getElementById('success-message').classList.add('show');
  }
  
  function hideMessages() {
    document.getElementById('error-message').classList.remove('show');
    document.getElementById('success-message').classList.remove('show');
  }
  
  // Utility functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  
  function formatTime(dateStr) {
    return new Date(dateStr).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  }
  
  function formatPhone(phone) {
    const cleaned = ('' + phone).replace(/\D/g, '');
    const match = cleaned.match(/^1?(\d{3})(\d{3})(\d{4})$/);
    if (match) {
      return '(' + match[1] + ') ' + match[2] + '-' + match[3];
    }
    return phone;
  }
  
  // Initialize
  loadAppointments();
  loadAvailability();
</script>
</body>
</html>
