<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindRobo ‚Äî Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    padding: 24px;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }
  
  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  h1 {
    font-size: 2rem;
    color: #38bdf8;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .nav-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .nav-link {
    padding: 10px 20px;
    background: #1e293b;
    color: #94a3b8;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  
  .nav-link:hover {
    background: #334155;
    color: #e2e8f0;
  }
  
  .nav-link.active {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .stat-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #38bdf8;
    margin-bottom: 4px;
  }
  
  .stat-change {
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .stat-change.positive { color: #22c55e; }
  .stat-change.negative { color: #ef4444; }
  
  /* Chart Section */
  .chart-section {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
  }
  
  .chart-header {
    margin-bottom: 20px;
  }
  
  .chart-title {
    font-size: 1.25rem;
    color: #e2e8f0;
    margin-bottom: 4px;
  }
  
  .chart-subtitle {
    font-size: 0.9rem;
    color: #64748b;
  }
  
  /* Bottom Row */
  .bottom-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  
  .info-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
  }
  
  .info-card h3 {
    font-size: 1.25rem;
    color: #e2e8f0;
    margin-bottom: 16px;
  }
  
  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #334155;
  }
  
  .info-row:last-child {
    border-bottom: none;
  }
  
  .info-label {
    color: #94a3b8;
    font-size: 0.95rem;
  }
  
  .info-value {
    color: #38bdf8;
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .quick-link {
    display: block;
    padding: 12px;
    background: #334155;
    border-radius: 8px;
    color: #e2e8f0;
    text-decoration: none;
    margin-bottom: 8px;
    transition: all 0.2s;
  }
  
  .quick-link:hover {
    background: #475569;
    transform: translateX(4px);
  }
  
  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #64748b;
  }
  
  .spinner {
    border: 3px solid #334155;
    border-top-color: #38bdf8;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Error */
  .error {
    background: #7f1d1d;
    border: 1px solid #991b1b;
    color: #fca5a5;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    body { padding: 16px; }
    h1 { font-size: 1.5rem; }
    .stat-value { font-size: 2rem; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚öôÔ∏è Admin Dashboard</h1>
    <div class="nav-links">
      <a href="/admin" class="nav-link active">Dashboard</a>
      <a href="/admin/users" class="nav-link">Users</a>
      <a href="/admin/trials" class="nav-link">Trials</a>
      <a href="/admin/usage" class="nav-link">Usage</a>
      <a href="/admin/audit" class="nav-link">Audit</a>
      <a href="/admin/health-check" class="nav-link">Health</a>
    </div>
  </div>

  <div id="error-container"></div>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>Loading analytics...</div>
  </div>

  <div id="content" style="display: none;">
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="total-users">-</div>
        <div class="stat-change positive" id="users-change">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Signups This Week</div>
        <div class="stat-value" id="signups-week">-</div>
        <div class="stat-change positive" id="signups-change">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">MRR</div>
        <div class="stat-value" id="mrr">-</div>
        <div class="stat-change positive" id="mrr-change">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Trials</div>
        <div class="stat-value" id="active-trials">-</div>
        <div class="stat-change" id="trials-change">-</div>
      </div>
    </div>

    <!-- Growth Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-title">User Growth</div>
        <div class="chart-subtitle">Signups over the last 30 days</div>
      </div>
      <canvas id="growthChart"></canvas>
    </div>

    <!-- Onboarding Funnel Widget -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-title">üìä Onboarding Funnel</div>
        <div class="chart-subtitle">User progression through onboarding stages</div>
      </div>
      <div id="funnelLoading" class="loading" style="padding: 20px;">Loading funnel data...</div>
      <canvas id="funnelChart" style="display: none;"></canvas>
      <div id="funnelStats" style="display: none; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
          <div style="text-align: center; padding: 12px; background: rgba(56, 189, 248, 0.1); border-radius: 8px;">
            <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Overall Completion</div>
            <div id="funnelCompletionRate" style="font-size: 1.5rem; color: #38bdf8; font-weight: 700;">-</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(56, 189, 248, 0.1); border-radius: 8px;">
            <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Avg. Drop-off</div>
            <div id="funnelAvgDropoff" style="font-size: 1.5rem; color: #f59e0b; font-weight: 700;">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Row -->
    <div class="bottom-row">
      <!-- Revenue Card -->
      <div class="info-card">
        <h3>üí∞ Revenue Breakdown</h3>
        <div class="info-row">
          <span class="info-label">Total Revenue</span>
          <span class="info-value" id="total-revenue">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Paid Users</span>
          <span class="info-value" id="paid-users">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Trial Users</span>
          <span class="info-value" id="trial-users">-</span>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="info-card">
        <h3>üîó Quick Links</h3>
        <a href="/admin/users" class="quick-link">‚Üí Manage Users</a>
        <a href="/admin/trials" class="quick-link">‚Üí Monitor Trials</a>
        <a href="/analytics" class="quick-link">‚Üí Analytics Dashboard</a>
        <a href="/warroom" class="quick-link">‚Üí War Room</a>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = window.location.origin;
  
  async function loadDashboard() {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      const response = await fetch(`${API_BASE}/api/v1/admin/analytics`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      
      // Populate stats
      document.getElementById('total-users').textContent = data.total_users || 0;
      document.getElementById('signups-week').textContent = data.signups_this_week || 0;
      document.getElementById('mrr').textContent = `$${(data.mrr || 0).toLocaleString()}`;
      document.getElementById('active-trials').textContent = data.active_trials || 0;

      // Changes
      document.getElementById('users-change').textContent = data.users_change || '+0%';
      document.getElementById('signups-change').textContent = data.signups_change || '+0%';
      document.getElementById('mrr-change').textContent = data.mrr_change || '+0%';
      document.getElementById('trials-change').textContent = data.trials_change || '0%';

      // Revenue
      document.getElementById('total-revenue').textContent = `$${(data.total_revenue || 0).toLocaleString()}`;
      document.getElementById('paid-users').textContent = data.paid_users || 0;
      document.getElementById('trial-users').textContent = data.trial_users || 0;

      // Growth chart
      const chartData = data.growth_chart || { labels: [], data: [] };
      const ctx = document.getElementById('growthChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Signups',
            data: chartData.data,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56, 189, 248, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#94a3b8' },
              grid: { color: '#334155' }
            },
            x: {
              ticks: { color: '#94a3b8' },
              grid: { color: '#334155' }
            }
          }
        }
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
      // Load funnel data
      loadFunnelData(token);
    } catch (err) {
      console.error('Load error:', err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-container').innerHTML = `
        <div class="error">‚ö†Ô∏è Failed to load analytics: ${err.message}</div>
      `;
    }
  }

  // Load onboarding funnel data
  async function loadFunnelData(token) {
    // Expected API schema (to be implemented by Backend):
    // GET /api/v1/admin/analytics/funnel
    // Response: {
    //   "stages": [
    //     { "name": "Signed Up", "count": 1000 },
    //     { "name": "Verified Email", "count": 850, "dropoff_percentage": 15.0 },
    //     { "name": "Completed Onboarding", "count": 720, "dropoff_percentage": 15.3 },
    //     { "name": "Set Personality", "count": 650, "dropoff_percentage": 9.7 },
    //     { "name": "Configured Phone", "count": 580, "dropoff_percentage": 10.8 },
    //     { "name": "First Call", "count": 520, "dropoff_percentage": 10.3 }
    //   ]
    // }
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/admin/analytics/funnel`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      let funnelData;
      
      if (response.status === 404) {
        // API not implemented yet - use mock data
        funnelData = {
          stages: [
            { name: "Signed Up", count: 1000 },
            { name: "Verified Email", count: 850, dropoff_percentage: 15.0 },
            { name: "Completed Onboarding", count: 720, dropoff_percentage: 15.3 },
            { name: "Set Personality", count: 650, dropoff_percentage: 9.7 },
            { name: "Configured Phone", count: 580, dropoff_percentage: 10.8 },
            { name: "First Call", count: 520, dropoff_percentage: 10.3 }
          ]
        };
      } else if (response.ok) {
        funnelData = await response.json();
      } else {
        throw new Error('Failed to load funnel data');
      }
      
      // Calculate overall metrics
      const firstStage = funnelData.stages[0].count;
      const lastStage = funnelData.stages[funnelData.stages.length - 1].count;
      const completionRate = ((lastStage / firstStage) * 100).toFixed(1);
      
      const dropoffs = funnelData.stages.slice(1).map(s => s.dropoff_percentage || 0);
      const avgDropoff = (dropoffs.reduce((a, b) => a + b, 0) / dropoffs.length).toFixed(1);
      
      document.getElementById('funnelCompletionRate').textContent = `${completionRate}%`;
      document.getElementById('funnelAvgDropoff').textContent = `${avgDropoff}%`;
      
      // Render funnel chart
      const ctx = document.getElementById('funnelChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: funnelData.stages.map(s => s.name),
          datasets: [{
            label: 'Users',
            data: funnelData.stages.map(s => s.count),
            backgroundColor: [
              'rgba(56, 189, 248, 0.8)',
              'rgba(14, 165, 233, 0.8)',
              'rgba(6, 182, 212, 0.8)',
              'rgba(20, 184, 166, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(34, 197, 94, 0.8)'
            ],
            borderColor: [
              '#38bdf8',
              '#0ea5e9',
              '#06b6d4',
              '#14b8a6',
              '#10b981',
              '#22c55e'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const stage = funnelData.stages[context.dataIndex];
                  if (stage.dropoff_percentage !== undefined) {
                    return `Drop-off: ${stage.dropoff_percentage.toFixed(1)}%`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: '#94a3b8' },
              grid: { color: '#334155' }
            },
            y: {
              ticks: { color: '#94a3b8' },
              grid: { display: false }
            }
          }
        }
      });
      
      document.getElementById('funnelLoading').style.display = 'none';
      document.getElementById('funnelChart').style.display = 'block';
      document.getElementById('funnelStats').style.display = 'block';
      
    } catch (err) {
      console.error('Funnel load error:', err);
      document.getElementById('funnelLoading').innerHTML = '‚ö†Ô∏è Failed to load funnel data';
    }
  }

  loadDashboard();
</script>

</body>
</html>
