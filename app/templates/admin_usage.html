<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindRobo â€” Admin Usage Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    padding: 24px;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }
  
  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  h1 {
    font-size: 2rem;
    color: #38bdf8;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .nav-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .nav-link {
    padding: 10px 20px;
    background: #1e293b;
    color: #94a3b8;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  
  .nav-link:hover {
    background: #334155;
    color: #e2e8f0;
  }
  
  .nav-link.active {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .stat-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #38bdf8;
    margin-bottom: 4px;
  }
  
  .stat-subtext {
    font-size: 0.85rem;
    color: #64748b;
  }
  
  /* Chart Card */
  .chart-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
  }
  
  .chart-title {
    font-size: 1.2rem;
    color: #e2e8f0;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
  }
  
  /* Table */
  .table-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
    overflow-x: auto;
  }
  
  .table-title {
    font-size: 1.2rem;
    color: #e2e8f0;
    margin-bottom: 20px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  thead {
    background: #0f172a;
  }
  
  th {
    padding: 12px;
    text-align: left;
    font-size: 0.85rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #334155;
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid #334155;
    color: #e2e8f0;
  }
  
  tbody tr:hover {
    background: #0f172a;
  }
  
  .margin-positive {
    color: #22c55e;
    font-weight: 600;
  }
  
  .margin-negative {
    color: #ef4444;
    font-weight: 600;
  }
  
  .flagged-user {
    background: rgba(239, 68, 68, 0.1);
  }
  
  .loading {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
  }
  
  .error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    border-radius: 8px;
    padding: 16px;
    color: #fca5a5;
    margin: 20px 0;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    body { padding: 16px; }
    h1 { font-size: 1.5rem; }
    .stat-value { font-size: 2rem; }
    .nav-links { width: 100%; }
    .nav-link { flex: 1; text-align: center; }
    table { font-size: 0.85rem; }
    th, td { padding: 8px; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ðŸ’° Usage Dashboard</h1>
    <div class="nav-links">
      <a href="/admin" class="nav-link">Dashboard</a>
      <a href="/admin/users" class="nav-link">Users</a>
      <a href="/admin/trials" class="nav-link">Trials</a>
      <a href="/admin/usage" class="nav-link active">Usage</a>
      <a href="/admin/audit" class="nav-link">Audit</a>
      <a href="/admin/health-check" class="nav-link">Health</a>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Platform Spend</div>
      <div class="stat-value" id="total-spend">â€”</div>
      <div class="stat-subtext">All-time usage costs</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">This Month</div>
      <div class="stat-value" id="month-spend">â€”</div>
      <div class="stat-subtext">Current billing cycle</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Avg Cost Per User</div>
      <div class="stat-value" id="avg-per-user">â€”</div>
      <div class="stat-subtext">30-day average</div>
    </div>
  </div>

  <!-- Daily Cost Trend Chart -->
  <div class="chart-card">
    <div class="chart-title">ðŸ“ˆ Daily Cost Trend (Last 30 Days)</div>
    <div class="chart-container">
      <canvas id="cost-trend-chart"></canvas>
    </div>
  </div>

  <!-- Service Breakdown Chart -->
  <div class="chart-card">
    <div class="chart-title">ðŸ§© Service Breakdown</div>
    <div class="chart-container">
      <canvas id="service-breakdown-chart"></canvas>
    </div>
  </div>

  <!-- Per-User Table -->
  <div class="table-card">
    <div class="chart-title">ðŸ‘¥ Per-User Usage & Margin</div>
    <div id="user-table-loading" class="loading">Loading user data...</div>
    <div id="user-table-error" class="error" style="display: none;"></div>
    <table id="user-table" style="display: none;">
      <thead>
        <tr>
          <th>Email</th>
          <th>Plan Price</th>
          <th>Total Cost</th>
          <th>Margin</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="user-table-body">
      </tbody>
    </table>
  </div>
</div>

<script>
// ============================================================================
// FETCH DATA
// ============================================================================

async function fetchStats() {
  try {
    const response = await fetch('/api/v1/admin/usage/summary', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }
    
    const data = await response.json();
    
    // Fix 2: Use correct field names from API
    document.getElementById('total-spend').textContent = 
      data.total_cost_cents ? `$${(data.total_cost_cents / 100).toFixed(2)}` : '$0.00';
    
    // Month spend: calculate from total_cost_cents if needed, or fetch separately
    // For now, display total (API doesn't return month_spend)
    document.getElementById('month-spend').textContent = 
      data.total_cost_cents ? `$${(data.total_cost_cents / 100).toFixed(2)}` : '$0.00';
    
    // Avg per user: calculate client-side if user_count available
    const avgPerUser = (data.user_count && data.total_cost_cents) 
      ? data.total_cost_cents / data.user_count 
      : 0;
    document.getElementById('avg-per-user').textContent = `$${(avgPerUser / 100).toFixed(2)}`;
    
    // Service breakdown for pie chart
    if (data.service_breakdown) {
      renderServiceBreakdown(data.service_breakdown);
    }
  } catch (error) {
    console.error('Failed to fetch usage stats:', error);
    // Set fallback values
    document.getElementById('total-spend').textContent = '$0.00';
    document.getElementById('month-spend').textContent = '$0.00';
    document.getElementById('avg-per-user').textContent = '$0.00';
  }
}

async function fetchTrends() {
  try {
    const response = await fetch('/api/v1/admin/usage/trends', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }
    
    // Fix 3: API returns array directly, not wrapped in .trends
    const data = await response.json();
    renderCostTrendChart(data || []);
  } catch (error) {
    console.error('Failed to fetch usage trends:', error);
    // Render empty chart
    renderCostTrendChart([]);
  }
}

async function fetchPerUserData() {
  try {
    // Fix 1: Use /margin endpoint instead of /per-user
    const response = await fetch('/api/v1/admin/usage/margin', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }
    
    // Fix 4: API returns array directly, not wrapped in .users
    const data = await response.json();
    renderUserTable(data || []);
  } catch (error) {
    console.error('Failed to fetch per-user data:', error);
    document.getElementById('user-table-loading').style.display = 'none';
    const errorDiv = document.getElementById('user-table-error');
    errorDiv.textContent = 'Failed to load user data. API endpoint may not be implemented yet.';
    errorDiv.style.display = 'block';
  }
}

// ============================================================================
// RENDER FUNCTIONS
// ============================================================================

function renderCostTrendChart(trends) {
  const ctx = document.getElementById('cost-trend-chart').getContext('2d');
  
  // Generate labels (last 30 days)
  const labels = trends.map(t => t.date) || generateLast30Days();
  // Fix 3: Use total_cost_cents instead of cost_cents
  const costs = trends.map(t => t.total_cost_cents / 100) || new Array(30).fill(0);
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Daily Cost ($)',
        data: costs,
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56, 189, 248, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#94a3b8' },
          grid: { color: '#334155' }
        },
        x: {
          ticks: { 
            color: '#94a3b8',
            maxRotation: 45,
            minRotation: 45
          },
          grid: { color: '#334155' }
        }
      }
    }
  });
}

function renderServiceBreakdown(breakdown) {
  const ctx = document.getElementById('service-breakdown-chart').getContext('2d');
  
  const services = Object.keys(breakdown);
  const costs = Object.values(breakdown).map(c => c / 100);
  
  const colors = [
    '#38bdf8',
    '#22c55e',
    '#f59e0b',
    '#ef4444',
    '#8b5cf6'
  ];
  
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: services,
      datasets: [{
        data: costs,
        backgroundColor: colors.slice(0, services.length),
        borderColor: '#1e293b',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#e2e8f0', padding: 20 }
        }
      }
    }
  });
}

function renderUserTable(users) {
  document.getElementById('user-table-loading').style.display = 'none';
  const table = document.getElementById('user-table');
  const tbody = document.getElementById('user-table-body');
  
  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #94a3b8;">No usage data available</td></tr>';
    table.style.display = 'table';
    return;
  }
  
  tbody.innerHTML = users.map(user => {
    // Fix 4: Use correct field names from margin endpoint
    const planPrice = user.plan_price_cents || 0;
    const totalCost = user.total_cost_cents || 0;
    const margin = user.margin_cents || 0;
    // Use is_profitable for highlighting instead of manual comparison
    const marginClass = user.is_profitable ? 'margin-positive' : 'margin-negative';
    const rowClass = !user.is_profitable ? 'flagged-user' : '';
    
    return `
      <tr class="${rowClass}">
        <td>${user.user_email}</td>
        <td>$${(planPrice / 100).toFixed(2)}</td>
        <td>$${(totalCost / 100).toFixed(2)}</td>
        <td class="${marginClass}">${margin >= 0 ? '+' : ''}$${(margin / 100).toFixed(2)}</td>
        <td>${!user.is_profitable ? 'ðŸš© Flagged' : 'âœ“ Normal'}</td>
      </tr>
    `;
  }).join('');
  
  table.style.display = 'table';
}

function generateLast30Days() {
  const days = [];
  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    days.push(date.toISOString().split('T')[0]);
  }
  return days;
}

// ============================================================================
// INIT
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  fetchStats();
  fetchTrends();
  fetchPerUserData();
});
</script>

</body>
</html>
