<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindRobo ‚Äî Onboarding</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    padding: 24px;
  }
  .container { max-width: 900px; margin: 0 auto; }
  
  /* Header */
  h1 { font-size: 2rem; color: #38bdf8; margin-bottom: 8px; }
  .subtitle { color: #94a3b8; margin-bottom: 32px; font-size: 1rem; }
  
  /* Progress Steps */
  .steps {
    display: flex;
    gap: 16px;
    margin-bottom: 48px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .step {
    flex: 1;
    min-width: 140px;
    max-width: 180px;
    text-align: center;
    padding: 16px;
    background: #1e293b;
    border-radius: 12px;
    border: 2px solid #334155;
    transition: all 0.3s;
  }
  .step.active {
    border-color: #38bdf8;
    background: #1e3a52;
  }
  .step.completed {
    border-color: #10b981;
    background: #064e3b;
  }
  .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #334155;
    color: #94a3b8;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin: 0 auto 8px;
    font-size: 1.1rem;
  }
  .step.active .step-number {
    background: #38bdf8;
    color: #0f172a;
  }
  .step.completed .step-number {
    background: #10b981;
    color: #fff;
  }
  .step-title {
    font-size: 0.85rem;
    color: #94a3b8;
  }
  .step.active .step-title {
    color: #38bdf8;
  }
  .step.completed .step-title {
    color: #10b981;
  }
  
  /* Content Sections */
  .content-section {
    display: none;
    animation: fadeIn 0.3s;
  }
  .content-section.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Forms */
  .form-group {
    margin-bottom: 24px;
  }
  label {
    display: block;
    font-size: 0.9rem;
    color: #94a3b8;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  label.required::after {
    content: ' *';
    color: #ef4444;
  }
  input[type="text"],
  input[type="url"],
  input[type="file"],
  textarea,
  select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #e2e8f0;
    font-size: 1rem;
    outline: none;
    font-family: inherit;
  }
  textarea {
    resize: vertical;
    min-height: 100px;
  }
  input:focus,
  textarea:focus,
  select:focus {
    border-color: #38bdf8;
  }
  input.error,
  textarea.error {
    border-color: #ef4444;
  }
  .error-text {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: 4px;
    display: none;
  }
  .error-text.show {
    display: block;
  }
  
  /* Radio Group */
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .radio-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #1e293b;
    cursor: pointer;
    transition: all 0.2s;
  }
  .radio-option:hover {
    border-color: #38bdf8;
    background: #1e3a52;
  }
  .radio-option.selected {
    border-color: #38bdf8;
    background: #1e3a52;
  }
  .radio-option input[type="radio"] {
    width: auto;
    cursor: pointer;
  }
  .radio-label {
    flex: 1;
    text-transform: none;
    margin: 0;
    letter-spacing: normal;
    color: #e2e8f0;
    cursor: pointer;
  }
  .radio-description {
    font-size: 0.8rem;
    color: #94a3b8;
    margin-top: 4px;
  }
  
  /* File Upload */
  .file-upload-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  .file-upload-label {
    display: block;
    padding: 16px;
    border: 2px dashed #334155;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #1e293b;
  }
  .file-upload-label:hover {
    border-color: #38bdf8;
    background: #1e3a52;
  }
  .file-upload-label.has-file {
    border-color: #10b981;
    background: #064e3b;
  }
  input[type="file"] {
    display: none;
  }
  .file-name {
    color: #10b981;
    font-weight: 600;
    margin-top: 8px;
  }
  
  /* Divider */
  .divider {
    display: flex;
    align-items: center;
    margin: 32px 0;
    color: #64748b;
    font-size: 0.9rem;
  }
  .divider::before,
  .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #334155;
  }
  .divider span {
    padding: 0 16px;
  }
  
  /* Review Table */
  .review-table {
    background: #1e293b;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
  }
  .chunk-item {
    border-bottom: 1px solid #334155;
    padding: 16px;
    display: flex;
    gap: 16px;
    align-items: start;
    transition: background 0.2s;
  }
  .chunk-item:hover {
    background: #334155;
  }
  .chunk-item:last-child {
    border-bottom: none;
  }
  .chunk-checkbox {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    margin-top: 4px;
    cursor: pointer;
  }
  .chunk-content {
    flex: 1;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #cbd5e1;
  }
  .chunk-meta {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 4px;
  }
  .select-all-wrapper {
    padding: 12px 16px;
    background: #334155;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
  }
  
  /* Buttons */
  .btn {
    padding: 14px 24px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary {
    background: #38bdf8;
    color: #0f172a;
  }
  .btn-primary:hover {
    background: #0ea5e9;
  }
  .btn-primary:disabled {
    background: #475569;
    cursor: not-allowed;
    opacity: 0.6;
  }
  .btn-secondary {
    background: #334155;
    color: #e2e8f0;
  }
  .btn-secondary:hover {
    background: #475569;
  }
  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }
  
  /* Messages */
  .message {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    display: none;
  }
  .message.show {
    display: block;
  }
  .message-error {
    background: #7f1d1d;
    border: 1px solid #ef4444;
    color: #fca5a5;
  }
  .message-success {
    background: #064e3b;
    border: 1px solid #10b981;
    color: #6ee7b7;
  }
  .message-info {
    background: #1e3a52;
    border: 1px solid #38bdf8;
    color: #7dd3fc;
  }
  
  /* Loading Spinner */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #334155;
    border-top-color: #38bdf8;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Summary */
  .summary-card {
    background: #1e293b;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }
  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #334155;
  }
  .summary-item:last-child {
    border-bottom: none;
  }
  .summary-label {
    color: #94a3b8;
  }
  .summary-value {
    color: #e2e8f0;
    font-weight: 600;
  }
  
  /* Mobile Responsive */
  @media (max-width: 768px) {
    body {
      padding: 16px;
    }
    h1 {
      font-size: 1.5rem;
    }
    .steps {
      gap: 8px;
    }
    .step {
      min-width: 120px;
      padding: 12px;
    }
    .button-group {
      flex-direction: column;
    }
    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üìû MindRobo Onboarding</h1>
  <p class="subtitle">Train your AI receptionist on your business knowledge ‚Äî it takes 2 minutes.</p>
  
  <!-- Progress Steps -->
  <div class="steps">
    <div class="step active" id="step-indicator-1">
      <div class="step-number">1</div>
      <div class="step-title">Ingest</div>
    </div>
    <div class="step" id="step-indicator-2">
      <div class="step-number">2</div>
      <div class="step-title">Personality</div>
    </div>
    <div class="step" id="step-indicator-3">
      <div class="step-number">3</div>
      <div class="step-title">Review</div>
    </div>
    <div class="step" id="step-indicator-4">
      <div class="step-number">4</div>
      <div class="step-title">Publish</div>
    </div>
  </div>
  
  <!-- Messages -->
  <div class="message message-error" id="error-message"></div>
  <div class="message message-success" id="success-message"></div>
  
  <!-- Step 1: Ingest -->
  <div class="content-section active" id="step-1">
    <div class="form-group">
      <label for="website-url">Business Website URL</label>
      <input type="url" id="website-url" placeholder="https://yourcompany.com">
    </div>
    
    <div class="divider"><span>OR</span></div>
    
    <div class="form-group">
      <label>Upload PDF (menu, FAQ, policy document)</label>
      <div class="file-upload-wrapper">
        <input type="file" id="pdf-upload" accept=".pdf,application/pdf">
        <label for="pdf-upload" class="file-upload-label" id="file-label">
          <span>üìÑ Click to select a PDF file</span>
          <div class="file-name" id="file-name" style="display: none;"></div>
        </label>
      </div>
    </div>
    
    <div class="button-group">
      <button class="btn btn-secondary" id="back-to-dashboard">‚Üê Back to Dashboard</button>
      <button class="btn btn-primary" id="extract-btn">
        Extract Knowledge
        <span class="spinner" style="display: none;" id="extract-spinner"></span>
      </button>
    </div>
  </div>
  
  <!-- Step 2: Agent Personality -->
  <div class="content-section" id="step-2">
    <p style="margin-bottom: 24px; color: #94a3b8;">
      Configure how your AI receptionist introduces your business and handles incoming calls.
    </p>
    
    <!-- AI Knowledge Display (shows what was extracted from website/PDF) -->
    <div id="ai-knowledge-section" style="display: none; margin-bottom: 32px;">
      <div class="summary-card">
        <h3 style="margin-bottom: 16px; color: #38bdf8; display: flex; align-items: center; gap: 8px;">
          ü§ñ What Your AI Assistant Learned
          <span style="font-size: 0.8rem; color: #64748b; font-weight: normal;">from <span id="extraction-source"></span></span>
        </h3>
        <div id="extracted-info" style="font-size: 0.9rem; color: #cbd5e1;">
          <!-- Extracted business info will be displayed here -->
        </div>
        <p style="margin-top: 12px; font-size: 0.8rem; color: #64748b;">
          üí° We've pre-filled the form below with this information. Review and adjust as needed.
        </p>
      </div>
    </div>
    
    <div class="form-group">
      <label for="business-name" class="required">Business Name</label>
      <input type="text" id="business-name" placeholder="Tampa Pool Pro">
      <div class="error-text" id="business-name-error">Business name is required</div>
    </div>
    
    <div class="form-group">
      <label for="business-description" class="required">What You Do</label>
      <textarea id="business-description" placeholder="We're a pool cleaning and maintenance company serving the Tampa Bay area. We handle residential and commercial pools."></textarea>
      <div class="error-text" id="business-description-error">Description is required</div>
    </div>
    
    <div class="form-group">
      <label for="services-prices">Services & Prices (Optional)</label>
      <textarea id="services-prices" placeholder="Pool cleaning - $150/visit&#10;Equipment repair - $85/hr&#10;Chemical balancing - included"></textarea>
    </div>
    
    <div class="form-group">
      <label for="owner-name">Owner's Name</label>
      <input type="text" id="owner-name" placeholder="Mike Johnson">
    </div>
    
    <div class="form-group">
      <label>Lead Handling Preference</label>
      <div class="radio-group">
        <label class="radio-option" id="radio-appointment">
          <input type="checkbox" name="lead-handling" value="book_appointment" checked>
          <div>
            <div class="radio-label">Book Appointment</div>
            <div class="radio-description">AI will offer to schedule an appointment. You can connect your calendar later in Settings.</div>
          </div>
        </label>
        <label class="radio-option" id="radio-sms">
          <input type="checkbox" name="lead-handling" value="send_sms" checked>
          <div>
            <div class="radio-label">Send SMS to Owner</div>
            <div class="radio-description">Notify owner via text message with lead details</div>
          </div>
        </label>
        <label class="radio-option" id="radio-message">
          <input type="checkbox" name="lead-handling" value="take_message" checked>
          <div>
            <div class="radio-label">Take a Message</div>
            <div class="radio-description">AI will collect contact info and reason for calling</div>
          </div>
        </label>
      </div>
    </div>
    

    
    <div class="button-group">
      <button class="btn btn-secondary" id="back-to-ingest">‚Üê Back</button>
      <button class="btn btn-primary" id="save-personality-btn">
        Save & Continue
        <span class="spinner" style="display: none;" id="personality-spinner"></span>
      </button>
    </div>
  </div>
  
  <!-- Step 3: Review -->
  <div class="content-section" id="step-3">
    <p style="margin-bottom: 24px; color: #94a3b8;">
      Review the knowledge chunks we extracted. Check the boxes for information you want your AI to know.
    </p>
    
    <div class="review-table">
      <div class="select-all-wrapper">
        <input type="checkbox" id="select-all" class="chunk-checkbox" checked>
        <label for="select-all" style="margin: 0; text-transform: none; color: #e2e8f0; cursor: pointer;">Select All</label>
        <span style="margin-left: auto; color: #64748b;" id="selected-count">0 selected</span>
      </div>
      <div id="chunks-container">
        <!-- Chunks will be inserted here -->
      </div>
    </div>
    
    <div class="button-group">
      <button class="btn btn-secondary" id="back-to-personality">‚Üê Back</button>
      <button class="btn btn-primary" id="continue-to-publish">
        Continue to Publish
      </button>
    </div>
  </div>
  
  <!-- Step 4: Publish -->
  <div class="content-section" id="step-4">
    <div class="summary-card">
      <h2 style="margin-bottom: 16px; color: #38bdf8;">Ready to Publish</h2>
      <div class="summary-item">
        <span class="summary-label">Source</span>
        <span class="summary-value" id="summary-source">‚Äî</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Chunks Selected</span>
        <span class="summary-value" id="summary-chunks">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Business ID</span>
        <span class="summary-value" id="summary-business">‚Äî</span>
      </div>
    </div>
    
    <div class="message message-info show">
      <strong>üìå What happens next:</strong><br>
      Your AI receptionist will be trained on this knowledge and will use it to answer customer calls.
      You can always add more knowledge or edit chunks later from your dashboard.
    </div>
    
    <div class="button-group">
      <button class="btn btn-secondary" id="back-to-review">‚Üê Back to Review</button>
      <button class="btn btn-primary" id="publish-btn">
        üöÄ Publish Knowledge
        <span class="spinner" style="display: none;" id="publish-spinner"></span>
      </button>
    </div>
  </div>
</div>

<script>
  // State
  let currentStep = 1;
  let extractedChunks = [];
  let selectedChunks = [];
  let sourceInfo = { type: '', value: '' };
  let personalityData = {
    businessName: '',
    description: '',
    servicesPrices: '',
    ownerName: '',
    leadHandling: 'appointment'
  };
  const businessId = new URLSearchParams(window.location.search).get('business_id')
    || localStorage.getItem('business_id')
    || '00000000-0000-0000-0000-000000000001';
  const jwtToken = localStorage.getItem('jwt_token');

  // If no business_id and no JWT, redirect to login
  if (businessId === '00000000-0000-0000-0000-000000000001' && !jwtToken) {
    window.location.href = '/login';
  }

  // If we have JWT but no business_id, try to get it from the JWT payload
  if (businessId === '00000000-0000-0000-0000-000000000001' && jwtToken) {
    try {
      const payload = JSON.parse(atob(jwtToken.split('.')[1]));
      if (payload.business_id) {
        localStorage.setItem('business_id', payload.business_id);
        window.location.reload();
      }
    } catch(e) { console.error('Failed to decode JWT:', e); }
  }
  
  // Elements
  const steps = [1, 2, 3, 4];
  const websiteUrlInput = document.getElementById('website-url');
  const pdfUploadInput = document.getElementById('pdf-upload');
  const fileLabel = document.getElementById('file-label');
  const fileNameEl = document.getElementById('file-name');
  const extractBtn = document.getElementById('extract-btn');
  const extractSpinner = document.getElementById('extract-spinner');
  
  // Personality form elements
  const businessNameInput = document.getElementById('business-name');
  const businessDescriptionInput = document.getElementById('business-description');
  const servicesPricesInput = document.getElementById('services-prices');
  const ownerNameInput = document.getElementById('owner-name');
  const leadHandlingRadios = document.querySelectorAll('input[name="lead-handling"]');
  // Removed: const greetingPreview = document.getElementById('greeting-preview');
  const savePersonalityBtn = document.getElementById('save-personality-btn');
  const personalitySpinner = document.getElementById('personality-spinner');
  const businessNameError = document.getElementById('business-name-error');
  const businessDescriptionError = document.getElementById('business-description-error');
  
  const selectAllCheckbox = document.getElementById('select-all');
  const chunksContainer = document.getElementById('chunks-container');
  const selectedCountEl = document.getElementById('selected-count');
  const continueToPublishBtn = document.getElementById('continue-to-publish');
  const backToDashboardBtn = document.getElementById('back-to-dashboard');
  const backToIngestBtn = document.getElementById('back-to-ingest');
  const backToPersonalityBtn = document.getElementById('back-to-personality');
  const backToReviewBtn = document.getElementById('back-to-review');
  const publishBtn = document.getElementById('publish-btn');
  const publishSpinner = document.getElementById('publish-spinner');
  const summarySourceEl = document.getElementById('summary-source');
  const summaryChunksEl = document.getElementById('summary-chunks');
  const summaryBusinessEl = document.getElementById('summary-business');
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  
  // File upload handler
  pdfUploadInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      fileLabel.classList.add('has-file');
      fileNameEl.textContent = file.name;
      fileNameEl.style.display = 'block';
      websiteUrlInput.value = ''; // Clear URL if file selected
    } else {
      fileLabel.classList.remove('has-file');
      fileNameEl.style.display = 'none';
    }
  });
  
  // Extract button
  extractBtn.addEventListener('click', async () => {
    hideMessages();
    let url = websiteUrlInput.value.trim();
    const file = pdfUploadInput.files[0];
    
    if (!url && !file) {
      showError('Please enter a website URL or upload a PDF.');
      return;
    }
    
    // Fix common URL format issues
    if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
      url = 'https://' + url;
      websiteUrlInput.value = url; // Update the input to show the corrected URL
    }
    
    extractBtn.disabled = true;
    extractSpinner.style.display = 'inline-block';
    
    try {
      let response;
      if (file) {
        // PDF upload
        const formData = new FormData();
        formData.append('pdf_file', file);
        formData.append('business_id', businessId);
        const pdfHeaders = {};
        if (jwtToken) pdfHeaders['Authorization'] = 'Bearer ' + jwtToken;
        response = await fetch('/api/v1/ingest/preview', {
          method: 'POST',
          headers: pdfHeaders,
          body: formData,
        });
        sourceInfo = { type: 'pdf', value: file.name };
      } else {
        // URL extraction
        const formData = new FormData();
        formData.append('url', url);
        formData.append('business_id', businessId);
        const headers = {};
        if (jwtToken) headers['Authorization'] = 'Bearer ' + jwtToken;
        response = await fetch('/api/v1/ingest/preview', {
          method: 'POST',
          headers: headers,
          body: formData,
        });
        sourceInfo = { type: 'url', value: url };
      }
      
      if (!response.ok) {
        const error = await response.json();
        const errorMsg = Array.isArray(error.detail) 
          ? error.detail.map(e => e.msg || e.message || JSON.stringify(e)).join(', ')
          : (error.detail || 'Failed to extract knowledge');
        throw new Error(errorMsg);
      }
      
      const data = await response.json();
      extractedChunks = data.chunks || [];
      
      if (extractedChunks.length === 0) {
        throw new Error('No content could be extracted from this source.');
      }
      
      // Store the extraction response for display in Step 2
      localStorage.setItem('extraction_data', JSON.stringify({
        chunks: extractedChunks,
        source_url: sourceInfo.value,
        extracted_metadata: data.extracted_metadata || {},
        title: data.title
      }));
      
      goToStep(2); // Go to personality step
    } catch (error) {
      showError(error.message);
    } finally {
      extractBtn.disabled = false;
      extractSpinner.style.display = 'none';
    }
  });
  
  // Removed: updateGreetingPreview function
  
  // Removed: event listeners for greeting preview
  
  // Radio button styling
  document.querySelectorAll('.radio-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      option.querySelector('input[type="radio"]').checked = true;
    });
  });
  
  // Save personality button
  savePersonalityBtn.addEventListener('click', async () => {
    hideMessages();
    
    // Validation
    const businessName = businessNameInput.value.trim();
    const description = businessDescriptionInput.value.trim();
    
    let hasError = false;
    
    if (!businessName) {
      businessNameInput.classList.add('error');
      businessNameError.classList.add('show');
      hasError = true;
    } else {
      businessNameInput.classList.remove('error');
      businessNameError.classList.remove('show');
    }
    
    if (!description) {
      businessDescriptionInput.classList.add('error');
      businessDescriptionError.classList.add('show');
      hasError = true;
    } else {
      businessDescriptionInput.classList.remove('error');
      businessDescriptionError.classList.remove('show');
    }
    
    if (hasError) {
      showError('Please fill in all required fields.');
      return;
    }
    
    // Collect data
    personalityData = {
      business_description: description,
      services_and_prices: servicesPricesInput.value.trim(),
      owner_name: ownerNameInput.value.trim() || null,
      lead_handling_preference: Array.from(document.querySelectorAll('input[name="lead-handling"]:checked')).map(cb => cb.value).join(',')
    };
    
    savePersonalityBtn.disabled = true;
    personalitySpinner.style.display = 'inline-block';
    
    try {
      // POST to backend API
      const persHeaders = { 'Content-Type': 'application/json' };
      if (jwtToken) persHeaders['Authorization'] = 'Bearer ' + jwtToken;
      const response = await fetch(`/api/v1/businesses/${businessId}/personality`, {
        method: 'POST',
        headers: persHeaders,
        body: JSON.stringify(personalityData),
      });
      
      if (!response.ok) {
        const error = await response.json();
        const errorMsg = Array.isArray(error.detail) 
          ? error.detail.map(e => e.msg || e.message || JSON.stringify(e)).join(', ')
          : (error.detail || 'Failed to save personality settings');
        throw new Error(errorMsg);
      }
      
      // Success - proceed to review step
      renderChunks();
      goToStep(3);
    } catch (error) {
      showError(error.message);
    } finally {
      savePersonalityBtn.disabled = false;
      personalitySpinner.style.display = 'none';
    }
  });
  
  // Render chunks in review table
  function renderChunks() {
    chunksContainer.innerHTML = '';
    selectedChunks = extractedChunks.map((_, i) => i); // All selected by default
    
    extractedChunks.forEach((chunk, index) => {
      const item = document.createElement('div');
      item.className = 'chunk-item';
      item.innerHTML = `
        <input type="checkbox" class="chunk-checkbox" id="chunk-${index}" checked data-index="${index}">
        <div class="chunk-content">
          ${escapeHtml(chunk.content)}
          <div class="chunk-meta">Source: ${chunk.source_type || 'webpage'}</div>
        </div>
      `;
      chunksContainer.appendChild(item);
      
      const checkbox = item.querySelector('.chunk-checkbox');
      checkbox.addEventListener('change', updateSelectedCount);
    });
    
    updateSelectedCount();
  }
  
  // Select all handler
  selectAllCheckbox.addEventListener('change', (e) => {
    const checkboxes = chunksContainer.querySelectorAll('.chunk-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
    updateSelectedCount();
  });
  
  // Update selected count
  function updateSelectedCount() {
    const checkboxes = chunksContainer.querySelectorAll('.chunk-checkbox');
    selectedChunks = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => parseInt(cb.dataset.index));
    selectedCountEl.textContent = `${selectedChunks.length} selected`;
    
    const allChecked = selectedChunks.length === extractedChunks.length;
    const noneChecked = selectedChunks.length === 0;
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
  }
  
  // Navigation
  backToDashboardBtn.addEventListener('click', () => window.location.href = '/dashboard');
  backToIngestBtn.addEventListener('click', () => goToStep(1));
  backToPersonalityBtn.addEventListener('click', () => goToStep(2));
  continueToPublishBtn.addEventListener('click', () => {
    if (selectedChunks.length === 0) {
      showError('Please select at least one chunk to publish.');
      return;
    }
    summarySourceEl.textContent = sourceInfo.type === 'pdf' ? sourceInfo.value : sourceInfo.value;
    summaryChunksEl.textContent = selectedChunks.length;
    summaryBusinessEl.textContent = businessId;
    goToStep(4);
  });
  backToReviewBtn.addEventListener('click', () => goToStep(3));
  
  // Publish button
  publishBtn.addEventListener('click', async () => {
    hideMessages();
    publishBtn.disabled = true;
    publishSpinner.style.display = 'inline-block';
    
    try {
      const chunksToPublish = selectedChunks.map(i => extractedChunks[i]);
      const response = await fetch('/api/v1/ingest/publish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business_id: businessId,
          chunks: chunksToPublish,
        }),
      });
      
      if (!response.ok) {
        const error = await response.json();
        const errorMsg = Array.isArray(error.detail) 
          ? error.detail.map(e => e.msg || e.message || JSON.stringify(e)).join(', ')
          : (error.detail || 'Failed to publish knowledge');
        throw new Error(errorMsg);
      }
      
      showSuccess(`‚úÖ Success! ${selectedChunks.length} knowledge chunks published. Your AI is now trained.`);
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 2000);
    } catch (error) {
      showError(error.message);
    } finally {
      publishBtn.disabled = false;
      publishSpinner.style.display = 'none';
    }
  });
  
  // Step navigation
  function goToStep(step) {
    currentStep = step;
    saveProgress(step);
    steps.forEach(s => {
      const section = document.getElementById(`step-${s}`);
      const indicator = document.getElementById(`step-indicator-${s}`);
      
      if (s === step) {
        section.classList.add('active');
        indicator.classList.add('active');
        indicator.classList.remove('completed');
      } else {
        section.classList.remove('active');
        indicator.classList.remove('active');
        if (s < step) {
          indicator.classList.add('completed');
        } else {
          indicator.classList.remove('completed');
        }
      }
    });
    
    // Load extracted metadata when going to Step 2 (Personality)
    if (step === 2) {
      loadExtractedMetadata();
    }
  }
  
  // Load extracted business metadata and auto-fill personality form
  async function loadExtractedMetadata() {
    try {
      // First try to get extraction data from current session
      const extractionData = localStorage.getItem('extraction_data');
      if (extractionData) {
        const data = JSON.parse(extractionData);
        console.log('Using stored extraction data:', data);
        
        if (data.extracted_metadata && Object.keys(data.extracted_metadata).length > 0) {
          // Show what the AI learned
          displayExtractedKnowledge({
            extracted_data: data.extracted_metadata,
            extraction_source: data.source_url || 'your website',
            has_extraction: true
          });
          
          // Auto-fill form fields with extracted data
          autoFillPersonalityForm({
            extracted_data: data.extracted_metadata
          });
          
          // Generate and update placeholders
          const placeholders = generatePlaceholdersFromData(data.extracted_metadata);
          updatePlaceholders(placeholders);
        }
        return;
      }
      
      // Fallback: try API call if we have a valid business ID
      if (!businessId || businessId === '00000000-0000-0000-0000-000000000001') {
        console.log('No extraction data available');
        return;
      }
      
      const headers = { 'Content-Type': 'application/json' };
      if (jwtToken) headers['Authorization'] = 'Bearer ' + jwtToken;
      
      const response = await fetch(`/api/v1/businesses/${businessId}/extracted-metadata`, {
        headers
      });
      
      if (!response.ok) {
        console.log('No extracted metadata available from API');
        return;
      }
      
      const apiData = await response.json();
      console.log('Extracted metadata from API:', apiData);
      
      if (apiData.has_extraction) {
        displayExtractedKnowledge(apiData);
        autoFillPersonalityForm(apiData);
        updatePlaceholders(apiData.placeholders);
      }
      
    } catch (error) {
      console.error('Failed to load extracted metadata:', error);
    }
  }
  
  // Display what the AI learned from the website/PDF
  function displayExtractedKnowledge(data) {
    const knowledgeSection = document.getElementById('ai-knowledge-section');
    const extractedInfo = document.getElementById('extracted-info');
    const extractionSource = document.getElementById('extraction-source');
    
    const extracted = data.extracted_data;
    let infoHtml = '';
    
    if (extracted.business_name) {
      infoHtml += `<div style="margin-bottom: 8px;"><strong>Business:</strong> ${extracted.business_name}</div>`;
    }
    
    if (extracted.business_description) {
      infoHtml += `<div style="margin-bottom: 8px;"><strong>What you do:</strong> ${extracted.business_description.substring(0, 150)}${extracted.business_description.length > 150 ? '...' : ''}</div>`;
    }
    
    if (extracted.services_and_prices) {
      const services = extracted.services_and_prices.split('\n').slice(0, 3); // First 3 services
      infoHtml += `<div style="margin-bottom: 8px;"><strong>Services found:</strong><br>${services.join('<br>')}</div>`;
    }
    
    if (extracted.owner_name) {
      infoHtml += `<div style="margin-bottom: 8px;"><strong>Owner:</strong> ${extracted.owner_name}</div>`;
    }
    
    if (extracted.phone) {
      infoHtml += `<div style="margin-bottom: 8px;"><strong>Phone:</strong> ${extracted.phone}</div>`;
    }
    
    if (infoHtml) {
      extractedInfo.innerHTML = infoHtml;
      extractionSource.textContent = data.extraction_source || 'your website';
      knowledgeSection.style.display = 'block';
    }
  }
  
  // Auto-fill personality form with extracted data
  function autoFillPersonalityForm(data) {
    const extracted = data.extracted_data;
    
    // Only fill if field is empty (don't overwrite user edits)
    if (extracted.business_name && !businessNameInput.value.trim()) {
      businessNameInput.value = extracted.business_name;
    }
    
    if (extracted.business_description && !businessDescriptionInput.value.trim()) {
      businessDescriptionInput.value = extracted.business_description;
    }
    
    if (extracted.services_and_prices && !servicesPricesInput.value.trim()) {
      servicesPricesInput.value = extracted.services_and_prices;
    }
    
    if (extracted.owner_name && !ownerNameInput.value.trim()) {
      ownerNameInput.value = extracted.owner_name;
    }
  }
  
  // Generate helpful placeholders from extracted data
  function generatePlaceholdersFromData(extracted_data) {
    const placeholders = {
      business_name: "Enter your business name (e.g., Tampa Pool Pro, ABC Lawn Care)",
      business_description: "Describe what your business does (e.g., We're a pool cleaning and maintenance company serving the Tampa Bay area)",
      services_and_prices: "List your main services and prices (e.g., Pool cleaning - $150/visit, Equipment repair - $85/hr)",
      owner_name: "Your name or business owner's name (e.g., Mike Johnson, Sarah Williams)"
    };
    
    // If we extracted data, show examples based on what we found
    if (extracted_data.business_name) {
      placeholders.business_name = `Your business name (we found: ${extracted_data.business_name})`;
    }
    
    if (extracted_data.owner_name) {
      placeholders.owner_name = `Owner name (we found: ${extracted_data.owner_name})`;
    }
    
    // Add industry-specific examples if we can detect the industry
    const content = (extracted_data.business_description || "") + " " + (extracted_data.services_and_prices || "");
    
    if (/pool|swimming|chlorine|chemical/i.test(content)) {
      placeholders.services_and_prices = "Pool cleaning - $150/visit, Equipment repair - $85/hr, Chemical balancing - included";
    } else if (/lawn|grass|landscaping|mowing/i.test(content)) {
      placeholders.services_and_prices = "Lawn mowing - $75/visit, Landscaping - $120/hr, Fertilization - $45/treatment";
    } else if (/hvac|heating|cooling|air/i.test(content)) {
      placeholders.services_and_prices = "AC repair - $150/visit, System maintenance - $200/year, Installation - $3500+";
    }
    
    return placeholders;
  }
  
  // Update form placeholders with helpful text
  function updatePlaceholders(placeholders) {
    if (placeholders.business_name) {
      businessNameInput.placeholder = placeholders.business_name;
    }
    
    if (placeholders.business_description) {
      businessDescriptionInput.placeholder = placeholders.business_description;
    }
    
    if (placeholders.services_and_prices) {
      servicesPricesInput.placeholder = placeholders.services_and_prices;
    }
    
    if (placeholders.owner_name) {
      ownerNameInput.placeholder = placeholders.owner_name;
    }
  }
  
  // Messages
  function showError(msg) {
    errorMessage.textContent = msg;
    errorMessage.classList.add('show');
  }
  
  function showSuccess(msg) {
    successMessage.textContent = msg;
    successMessage.classList.add('show');
  }
  
  function hideMessages() {
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Initialize
  summaryBusinessEl.textContent = businessId;
  document.querySelector('.radio-option').classList.add('selected');

  // ========== ONBOARDING PROGRESS TRACKING ==========
  async function saveProgress(step) {
    const token = localStorage.getItem('jwt_token');
    if (!token) return;
    try {
      await fetch('/api/v1/onboarding/progress/' + step, {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + token }
      });
    } catch (e) { console.log('Progress save failed:', e); }
  }

  async function loadProgress() {
    const token = localStorage.getItem('jwt_token');
    if (!token) return;
    try {
      const res = await fetch('/api/v1/onboarding/progress', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.ok) {
        const data = await res.json();
        if (data.completed) {
          window.location.href = '/dashboard';
          return;
        }
        if (data.step > 0 && data.step <= 4) {
          goToStep(data.step);
          showSuccess('Welcome back! Resuming from where you left off.');
          setTimeout(hideMessages, 3000);
        }
      }
    } catch (e) { console.log('Progress load failed:', e); }
  }

  // Load progress on page load
  loadProgress();
  // ========== END PROGRESS TRACKING ==========

  </script>
</body>
</html>
