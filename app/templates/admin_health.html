<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindRobo ‚Äî Integration Health</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    padding: 24px;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }
  
  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  h1 {
    font-size: 2rem;
    color: #38bdf8;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .nav-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .nav-link {
    padding: 10px 20px;
    background: #1e293b;
    color: #94a3b8;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  
  .nav-link:hover {
    background: #334155;
    color: #e2e8f0;
  }
  
  .nav-link.active {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
  }
  
  /* Last updated banner */
  .last-updated {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 16px 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  .last-updated-text {
    color: #94a3b8;
    font-size: 0.95rem;
  }
  
  .refresh-info {
    color: #64748b;
    font-size: 0.85rem;
  }
  
  /* Health cards grid */
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .health-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 24px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .health-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  }
  
  .health-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  
  .health-card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #e2e8f0;
  }
  
  .health-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .status-ok {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid #10b981;
  }
  
  .status-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid #f59e0b;
  }
  
  .status-error {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid #ef4444;
  }
  
  .health-details {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .health-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(51, 65, 85, 0.5);
  }
  
  .health-detail-row:last-child {
    border-bottom: none;
  }
  
  .detail-label {
    color: #94a3b8;
    font-size: 0.9rem;
  }
  
  .detail-value {
    color: #e2e8f0;
    font-size: 0.95rem;
    font-weight: 500;
  }
  
  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: 8px;
    padding: 12px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 8px;
    border-left: 3px solid #ef4444;
  }
  
  .loading {
    text-align: center;
    padding: 40px;
    color: #64748b;
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    body { padding: 12px; }
    h1 { font-size: 1.5rem; }
    .health-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üíö Integration Health</h1>
    <nav class="nav-links">
      <a href="/admin" class="nav-link">Dashboard</a>
      <a href="/admin/users" class="nav-link">Users</a>
      <a href="/admin/trials" class="nav-link">Trials</a>
      <a href="/admin/usage" class="nav-link">Usage</a>
      <a href="/admin/audit" class="nav-link">Audit</a>
      <a href="/admin/health-check" class="nav-link active">Health</a>
    </nav>
  </div>
  
  <!-- Last updated -->
  <div class="last-updated">
    <div class="last-updated-text">
      Last checked: <span id="lastUpdated">‚Äî</span>
    </div>
    <div class="refresh-info">
      Auto-refresh every 60 seconds
    </div>
  </div>
  
  <!-- Health cards -->
  <div class="health-grid" id="healthGrid">
    <div class="loading">Loading service health...</div>
  </div>
</div>

<script>
// Expected API schema (to be implemented by Backend):
// GET /api/v1/admin/health
// Response: {
//   "services": [
//     {
//       "name": "Database",
//       "status": "ok" | "warning" | "error",
//       "message": "Connected to PostgreSQL",
//       "details": {
//         "latency_ms": 12,
//         "connection_pool": "8/20"
//       }
//     },
//     {
//       "name": "Retell",
//       "status": "ok" | "warning" | "error",
//       "message": "API key configured",
//       "details": {
//         "api_key_configured": true,
//         "last_checked": "2024-01-15T14:30:00Z"
//       }
//     },
//     ...
//   ],
//   "timestamp": "2024-01-15T14:30:00Z"
// }

const API_BASE = '/api/v1';
let currentToken = null;
let refreshInterval = null;

// Check authentication
async function checkAuth() {
  currentToken = localStorage.getItem('token');
  if (!currentToken) {
    window.location.href = '/login';
    return false;
  }
  return true;
}

// Format timestamp
function formatTimestamp(isoString) {
  const date = new Date(isoString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

// Get status icon
function getStatusIcon(status) {
  const icons = {
    'ok': '‚úÖ',
    'warning': '‚ö†Ô∏è',
    'error': '‚ùå'
  };
  return icons[status] || '‚ùì';
}

// Get status class
function getStatusClass(status) {
  const classes = {
    'ok': 'status-ok',
    'warning': 'status-warning',
    'error': 'status-error'
  };
  return classes[status] || 'status-warning';
}

// Render health card
function renderHealthCard(service) {
  const detailsHtml = service.details 
    ? Object.entries(service.details).map(([key, value]) => `
        <div class="health-detail-row">
          <span class="detail-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
          <span class="detail-value">${value}</span>
        </div>
      `).join('')
    : '';
  
  const errorHtml = service.status === 'error' && service.error
    ? `<div class="error-message">${service.error}</div>`
    : '';
  
  return `
    <div class="health-card">
      <div class="health-card-header">
        <h3 class="health-card-title">${service.name}</h3>
        <div class="health-status ${getStatusClass(service.status)}">
          ${getStatusIcon(service.status)} ${service.status.toUpperCase()}
        </div>
      </div>
      <div class="health-details">
        ${detailsHtml}
      </div>
      ${errorHtml}
    </div>
  `;
}

// Load health status
async function loadHealthStatus() {
  if (!await checkAuth()) return;
  
  const grid = document.getElementById('healthGrid');
  
  try {
    const response = await fetch(`${API_BASE}/admin/health`, {
      headers: {
        'Authorization': `Bearer ${currentToken}`
      }
    });
    
    if (response.status === 401) {
      window.location.href = '/login';
      return;
    }
    
    if (response.status === 404) {
      // API not implemented yet - show mock data
      displayMockData();
      return;
    }
    
    if (!response.ok) {
      throw new Error('Failed to load health status');
    }
    
    const data = await response.json();
    
    // Update last updated timestamp
    document.getElementById('lastUpdated').textContent = formatTimestamp(data.timestamp);
    
    // Render health cards
    grid.innerHTML = data.services.map(service => renderHealthCard(service)).join('');
    
  } catch (error) {
    console.error('Error loading health status:', error);
    grid.innerHTML = '<div class="loading">‚ö†Ô∏è Error loading health status. Backend API not yet implemented.</div>';
  }
}

// Display mock data (temporary until backend is ready)
function displayMockData() {
  const grid = document.getElementById('healthGrid');
  const mockServices = [
    {
      name: 'Database',
      status: 'ok',
      message: 'Connected to PostgreSQL',
      details: {
        'Latency': '12 ms',
        'Connection Pool': '8/20',
        'Version': 'PostgreSQL 15.3'
      }
    },
    {
      name: 'Retell AI',
      status: 'ok',
      message: 'API key configured',
      details: {
        'API Key': 'Configured ‚úì',
        'Last Call': '2 minutes ago',
        'Agent Count': '3'
      }
    },
    {
      name: 'Twilio',
      status: 'ok',
      message: 'API key configured',
      details: {
        'API Key': 'Configured ‚úì',
        'Phone Numbers': '2',
        'Last SMS': '15 minutes ago'
      }
    },
    {
      name: 'Stripe',
      status: 'warning',
      message: 'Not configured',
      details: {
        'API Key': 'Not set',
        'Mode': 'Test'
      }
    },
    {
      name: 'SendGrid',
      status: 'ok',
      message: 'API key configured',
      details: {
        'API Key': 'Configured ‚úì',
        'Last Email': '1 hour ago',
        'Daily Quota': '450/500'
      }
    }
  ];
  
  // Update last updated timestamp
  document.getElementById('lastUpdated').textContent = formatTimestamp(new Date().toISOString());
  
  grid.innerHTML = mockServices.map(service => renderHealthCard(service)).join('');
  
  // Add note about mock data
  grid.innerHTML += `
    <div class="health-card" style="grid-column: 1 / -1; background: rgba(245, 158, 11, 0.1); border-color: #f59e0b;">
      <div style="text-align: center; color: #f59e0b;">
        <strong>‚ö†Ô∏è Showing mock data</strong><br>
        Backend API (/api/v1/admin/health) not yet implemented.
      </div>
    </div>
  `;
}

// Start auto-refresh
function startAutoRefresh() {
  // Clear existing interval
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
  
  // Refresh every 60 seconds
  refreshInterval = setInterval(() => {
    loadHealthStatus();
  }, 60000);
}

// Initialize
window.addEventListener('DOMContentLoaded', () => {
  loadHealthStatus();
  startAutoRefresh();
});

// Stop refresh on page unload
window.addEventListener('beforeunload', () => {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
});
</script>
</body>
</html>
